<!DOCTYPE html>
<html lang="en">
<head>
    <title>Hand and Foot</title>
    <link rel="stylesheet" type="text/css" href="app.css">
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>

<script type="text/babel">

/******************************************************************************
 * SelectPlayers
 *
 * Select the number of players that are playing hand and foot.
 * Choose between 4, 6, or 8 players.
 *****************************************************************************/
class SelectPlayers extends React.Component {
  constructor(props) {
    super(props)
    this.handleSelectChange = this.handleSelectChange.bind(this)
  }
  
  handleSelectChange(e) {
    this.props.onSelectChange(e.target.value)
  }

  render() {
    if (this.props.optionsSet === false) {
      return (
        <div>
          <label>Number of Players: </label>
          <select 
            value={this.props.opVal}
            onChange = {this.handleSelectChange}
          >
            <option value="None">Choose...</option>
            <option value="4">4</option>
            <option value="6">6</option>
            <option value="8">8</option>
          </select>
        </div>
      )
    } else {
        return null;
    }
  }
}

/******************************************************************************
 * NameInput
 *****************************************************************************/
class NameInput extends React.Component {
  constructor(props) {
    super(props)
    this.handleNameChange = this.handleNameChange.bind(this)
    this.handleSubmit = this.handleSubmit.bind(this)
  }
  
  handleNameChange(e) {
    this.props.onNameChange(e)
  }
  
  handleSubmit(e) {
    this.props.onSubmitForm(e)
  }
  
  createInputs() {
    let inputs = []
    
    for(let i = 0; i < this.props.opVal; i++) {
      if(i % 2 == 0) {
        inputs.push(<h3>Group {(i + 2) / 2}</h3>)
      }
      const name = "player" + (i + 1)
      inputs.push(
        <div className="name-input">
          <label htmlFor={name}>Name: </label>
          <input name={name} type="firstname" aria-required="true" value={this.props.name} onChange={this.handleNameChange} required />
        </div>
      )
    }
    return inputs
  }
  
  render() {
    if(this.props.opVal == "None" || this.props.optionsSet === true) {
      return null
    } else {
      return (
        <form onSubmit={this.handleSubmit}>
          {this.createInputs()}
          <div>
            <button>Start Game</button>
          </div>
        </form>
      )
    }
  }
}

/******************************************************************************
 * Player
 *
 * Arrow function component that displays information related to a player.
 *****************************************************************************/
const Player = ({player}) => {
  return (
    <div>
      <p className="player">{player.name}
        <span className="player-score"> {player.score}</span>
      </p>
    </div>
  );
};

/******************************************************************************
 * Group
 * 
 * A group consists of two players.
 *****************************************************************************/
class Group extends React.Component {
  constructor(props) {
    super(props);
  }

  componentDidMount() {
    // template
  }

  componentWillUnmount() {
    // template
  }

  render() {
    const player1 = this.props.player1;
    const player2 = this.props.player2;
    return (
      <div>
        <h3>Group {this.props.groupName}: {this.props.players[player1]["score"] + this.props.players[player2]["score"]}</h3>
        <Player player={this.props.players[player1]} />
        <Player player={this.props.players[player2]} />
      </div>
    );
  }
}

/******************************************************************************
 * ScoreInput
 *
 * ScoreInput can either be a checkbox, select box, or text box that accepts
 * an integer input depending on the score being kept.
 *
 * Props
 *  Player
 *  Round
 *  Category
 *****************************************************************************/
class ScoreInput extends React.Component {
  constructor(props) {
    super(props);
  }

  componentDidMount() {
    // template
  }

  componentWillUnmount() {
    // template
  }

  scoreSelectChange(player, round, category, e) {
    if(this.props.inputType == 'checkbox') {
      this.props.scoreSelectChange(player, round, category, e.target.checked ? 1 : 0);
    } else if(this.props.inputType == 'select') {
      this.props.scoreSelectChange(player, round, category, e.target.value);
    } else {
      this.props.scoreSelectChange(player, round, category, e.target.value);
    }
  }

  render() {
    if(this.props.inputType == 'checkbox') {
      let checkBoxVal = this.props.playerObj[this.props.round][this.props.category] == 1 ? true : false;
      return <input type="checkbox" defaultChecked={checkBoxVal} onChange={(e) => this.scoreSelectChange(this.props.player, this.props.round, this.props.category, e)}></input>
    } else if (this.props.inputType == 'select') {
      return (
        <select value={this.props.playerObj[this.props.round][this.props.category]}
         onChange={(e) => this.scoreSelectChange(
           this.props.player, this.props.round, this.props.category, e)}
        >
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
        </select>
      );
    } else if (this.props.inputType == 'number') {
      return <input type="number" min="0" max="1000" value={this.props.playerObj[this.props.round][this.props.category]} onChange={(e) => this.scoreSelectChange(this.props.player, this.props.round, this.props.category, e)}></input>
    }
  }
}


/******************************************************************************
 * RoundScore
 *****************************************************************************/
class RoundScore extends React.Component {
  constructor(props) {
    super(props);
    this.createInputs = this.createInputs.bind(this);
    this.scoreSelectChange = this.scoreSelectChange.bind(this);
    this.round = "round1";
  }

  componentDidMount() {
    // template
  }

  componentWillUnmount() {
    // template
  }

  scoreSelectChange(player, round, category, val) {
    this.props.scoreSelectChange(player, round, category, val)
  }

  createInputs(category, type) {
    let table = []

    for(const player in this.props.players) {
      table.push(
        <td>
          <ScoreInput playerObj={this.props.players[player]} player={player} round={this.round}
                      category={category} inputType={type}
                      scoreSelectChange={this.scoreSelectChange}/>
        </td>
      )
    }

    return table;
  }

  playerNames() {
    let names = []
    
    for(const player in this.props.players) {
      names.push(<th>{this.props.players[player].name}</th>);
    }

    return names;
  }

  render() {
    return(
    <div>
      <h4>Scores</h4>
      <table>
        <thead>
          <tr>
            <th>Type</th>
            {this.playerNames()}
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">Draw 22</th>
            {this.createInputs("pick", "checkbox")}
          </tr>
          <tr>
            <th scope="row">Out</th>
            {this.createInputs("out", "checkbox")}
          </tr>
          <tr>
            <th scope="row">Black Books</th>
            {this.createInputs("black", "select")}
          </tr>
          <tr>
            <th scope="row">Red Books</th>
            {this.createInputs("red", "select")}
          </tr>
          <tr>
            <th scope="row">Wild Books</th>
            {this.createInputs("wild", "select")}
          </tr>
          <tr>
            <th scope="row">Points</th>
            {this.createInputs("points", "number")}
          </tr>
        </tbody>
      </table>
    </div>
    );
  }
}

/******************************************************************************
 * Score
 *****************************************************************************/
class Score extends React.Component {
  constructor(props) {
    super(props);
    this.scoreSelectChange = this.scoreSelectChange.bind(this);
  }

  componentDidMount() {
    // template
  }

  componentWillUnmount() {
    // template
  }

  scoreSelectChange(player, round, category, val) {
    this.props.scoreSelectChange(player, round, category, val)
  }

  render() {
    if (this.props.optionsSet === false) {
      // do not render the score
      return null;
    } else {
      let scores = [];


      for(let i = 0; i < this.props.opVal; i += 2) {
        const name1 = "player" + (i + 1);
        const name2 = "player" + (i + 2);
        scores.push(
          <Group groupName={(i + 2) / 2} players={this.props.players} player1={name1} player2={name2} />
        )
      }

      return (
        <div>
          {scores}
          <RoundScore
            players={this.props.players}
            scoreSelectChange={this.scoreSelectChange} />
        </div>
      );
    }
  }
}

/******************************************************************************
 * HandAndFootApp
 *****************************************************************************/
class HandAndFootApp extends React.Component {
  constructor(props) {
    super(props)

    this.state = {
      opVal: "None",
      players: [],
      optionsSet: false
    }

    this.handleSelectChange = this.handleSelectChange.bind(this)
    this.handleNameChange = this.handleNameChange.bind(this)
    this.handleSubmit = this.handleSubmit.bind(this)
    this.scoreSelectChange = this.scoreSelectChange.bind(this)
    this.resetGame = this.resetGame.bind(this)
  }
  
  handleSelectChange(opVal) {
    this.setState( {opVal: opVal}, () => console.log(this.state.opVal) )
  }
  
  handleNameChange(event) {
    this.setState({
      players: {
        ...this.state.players,
        [event.target.name]: {
          name: event.target.value,
          score: 0,
          round1: {
            pick: 0,
            out: 0,
            black: 0,
            red: 0,
            wild: 0,
            points: 0,
            score: 0
          },
          round2: {
            pick: 0,
            out: 0,
            black: 0,
            red: 0,
            wild: 0,
            points: 0,
            score: 0
          },
          round3: {
            pick: 0,
            out: 0,
            black: 0,
            red: 0,
            wild: 0,
            points: 0,
            score: 0
          },
          round4: {
            pick: 0,
            out: 0,
            black: 0,
            red: 0,
            wild: 0,
            points: 0,
            score: 0
          }
        }
      }
    }, () =>
      console.log("Hey!"));
  }
  
  handleSubmit(event) {
    event.preventDefault();
    this.setState( {optionsSet: true}, () => console.log(this.state.optionsSet))

    console.log(this.state);
  }

  scoreSelectChange(player, round, category, val) {
    let roundSum = 0;
    let gameSum = 0;

    // sum the round score and save the state
    for(let score in this.state.players[player][round]) {
      let updVal = this.state.players[player][round][score];

      // if updated category, use updated score
      if (score == category) {
        updVal = val;
      }

      switch(score) {
        case "pick":
          roundSum += (updVal * 100);
          break;
        case "out":
          roundSum += (updVal * 100);
          break;
        case "black":
          roundSum += (updVal * 300);
          break;
        case "red":
          roundSum += (updVal * 500);
          break;
        case "wild":
          roundSum += (updVal * 2000);
          break;
        case "points":
          roundSum += parseInt(updVal);
          break;
        default:
          break;
      }
    }
    
    // sum the game score and save the state
    for(let gameRound in this.state.players[player]) {
      let roundScore = this.state.players[player][gameRound]["score"];

      // TODO: change state structure
      if(gameRound == "name" || gameRound == "score") {
        continue;
      }

      // if current round, use updated score
      if(gameRound == round) {
        roundScore = roundSum;
      }

      gameSum += roundScore;
    }

    this.setState({
      players: {
        ...this.state.players,
        [player]: {
          ...this.state.players[player],
          score: gameSum,
          [round]: {
            ...this.state.players[player][round],
            score: roundSum,
            [category]: val
          }
        }
      }
    });
  }

  resetGame() {
    var response = confirm("Are you sure you want to restart? The current game will be lost.");

    if(response) {
      this.setState({
        opVal: "None",
        players: [],
        optionsSet: false
      });
    }
  }
  
  render() {
    return (
      <div>
        <SelectPlayers
          opVal = {this.state.opVal}
          optionsSet = {this.state.optionsSet}
          onSelectChange = {this.handleSelectChange}
        />
        <NameInput 
          opVal = {this.state.opVal}
          optionsSet = {this.state.optionsSet}
          onNameChange = {this.handleNameChange}
          onSubmitForm = {this.handleSubmit}
        />
        <Score
          opVal = {this.state.opVal}
          players = {this.state.players}
          optionsSet = {this.state.optionsSet}
          scoreSelectChange = {this.scoreSelectChange}
        />

        {this.state.optionsSet === true &&
          <button onClick={this.resetGame}>Restart</button>
        }
      </div>
    )
  }
}

ReactDOM.render(
  <HandAndFootApp />,
  document.getElementById('root')
)
</script>

<h1>Hand and Foot</h1>

<div id="root"></div>